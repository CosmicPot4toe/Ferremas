{% extends 'app/base.html' %}
{% load static %}

{% load crispy_forms_tags %}
{% block contenido %}
<br><br><br><br><br>
<style>
    body {
        font-family: Arial, sans-serif;
    }

    .dashboard {
        display: flex;
    }

    .sidebar {
        width: 200px;
        background-color: #f8f9fa;
        padding: 15px;
    }

    .sidebar h2 {
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .sidebar ul {
        list-style-type: none;
        padding: 0;
    }

    .sidebar ul li {
        margin-bottom: 10px;
    }

    .sidebar ul li a {
        text-decoration: none;
        color: #007bff;
    }

    .content {
        flex-grow: 1;
        padding: 20px;
    }

    .table-container {
        margin-top: 20px;
    }

    .table-container h2 {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-container h2 button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .nav-list {
        list-style: none;
        padding: 0;
    }
    .nav-list li {
        margin-bottom: 10px;
    }
    .nav-list a {
        text-decoration: none;
        color: rgb(0, 0, 0);
        display: block;
        padding: 10px;
        transition: background-color 0.3s, color 0.3s;
    }
    .nav-list a:hover {
        background-color: #f0f0f0;
        color: #380e53;
    }
    .nav-list a.active {
        background-color: #380e53;
        color: white;
    }
</style>

<div class="dashboard">
    <div class="sidebar" style="border-radius: 5%;">
        <h2>Admin Dashboard</h2>
        <hr>
        <ul class="nav-list">
            <li><a href="#" onclick="showSection('usuarios')" id="usuarios-link">Usuarios</a></li>
            <li><a href="#" onclick="showSection('productos')" id="productos-link">Productos</a></li>
            <li><a href="#" onclick="showSection('tiendas')" id="tiendas-link">Tiendas</a></li>
            <li><a href="#" onclick="showSection('categorias')" id="categorias-link">Categorías</a></li>
            <li><a href="#" onclick="showSection('stock')" id="stock-link">Stock</a></li>
        </ul>
    </div>
    <div class="content">
        <div id="usuarios" class="table-container" style="width: 1000px; margin: 0 auto;">
            <h2 class="text-center">Usuarios 
                <button onclick="openModal('modal-add-user')" class="btn btn-lg" style="background-color:  #380e53; color: #ffffff;">Agregar Usuario</button>
            </h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover text-center">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.get_type_display }}</td>
                            <td>
                                <button onclick="openEditUserModal('modal-edit-user', {{ user.id }})" class="btn btn-warning">Editar</button>
                                <button onclick="deleteItem('delete_user', {{ user.id }})" class="btn btn-danger">Eliminar</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        

        <div id="productos" class="table-container" style="display:none;">
            <h2>Productos <button onclick="openModal('modal-add-producto')" class="btn btn-primary">Agregar Producto</button></h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Imagen</th>
                        <th>Descripción</th>
                        <th>Precio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td>{{ producto.nombre }}</td>
                        <td> <img src="{{producto.imagen_url}}" alt="" style="height: 100px;"></td>
                        <td>{{ producto.descripcion }}</td>
                        <td>{{ producto.precio }}</td>
                        <td>
                            <button onclick="openEditModal('modal-edit-producto', {{ producto.id }})" class="btn btn-warning">Editar</button>
                            <button onclick="deleteItem('delete_producto', {{ producto.id }})">Eliminar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="tiendas" class="table-container" style="display:none;">
            <h2>Tiendas <button onclick="openModal('modal-add-tienda')" class="btn btn-primary">Agregar Tienda</button></h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Dirección</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tienda in tiendas %}
                    <tr>
                        <td>{{ tienda.nombre }}</td>
                        <td>{{ tienda.direccion }}</td>
                        <td>
                            <button onclick="openEditModal('modal-edit-tienda', {{ tienda.id }})">Editar</button>
                            <button onclick="deleteItem('delete_tienda', {{ tienda.id }})">Eliminar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="categorias" class="table-container" style="display:none;">
            <h2>Categorías <button onclick="openModal('modal-add-categoria')" class="btn btn-primary">Agregar Categoría</button></h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for categoria in categorias %}
                    <tr>
                        <td>{{ categoria.nombre_categoria }}</td>
                        <td>
                            <button onclick="openEditModal('modal-edit-categoria', {{ categoria.id }})">Editar</button>
                            <button onclick="deleteItem('delete_categoria', {{ categoria.id }})">Eliminar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="stock" class="table-container" style="display:none;">
            <h2>Stock <button onclick="openModal('modal-add-stock')" class="btn btn-primary">Agregar Stock</button></h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Tienda</th>
                        <th>Cantidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stock %}
                    <tr>
                        <td>{{ item.producto.nombre }}</td>
                        <td>{{ item.tienda.nombre }}</td>
                        <td>{{ item.cantidad }}</td>
                        <td>
                            <button onclick="openEditModal('modal-edit-stock', {{ item.id }})">Editar</button>
                            <button onclick="deleteItem('delete_stock', {{ item.id }})">Eliminar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modales para agregar/editar usuarios -->
<div id="modal-add-user" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-add-user')">&times;</span>
        <h2>Agregar Usuario</h2>
        <form method="post" action="{% url 'create_user' %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="username">Usuario</label>
                <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password1">Contraseña</label>
                <input type="password" class="form-control" id="password1" name="password1" required>
            </div>
            <div class="form-group">
                <label for="password2">Confirma Contraseña</label>
                <input type="password" class="form-control" id="password2" name="password2" required>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">Agregar</button>
        </form>
    </div>
</div>

<!-- Modal para Editar Usuario -->
<div id="modal-edit-user" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-edit-user')">&times;</span>
        <h2>Editar Usuario</h2>
        <form id="editUserForm" method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="editUsername">Usuario</label>
                <input type="text" class="form-control" id="editUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="editEmail">Email</label>
                <input type="email" class="form-control" id="editEmail" name="email" required>
            </div>
            <div class="form-group">
                <label for="editType">Tipo</label>
                <select class="form-control" id="editType" name="type" required>
                    <option value="Bod">Bodeguero (Interno)</option>
                    <option value="Con">Contador (Interno)</option>
                    <option value="Ven">Vendedor (Interno)</option>
                    <option value="Cli">Cliente (Externo)</option>
                </select>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">Actualizar</button>
        </form>
    </div>
</div>






<!-- Modales para agregar/editar productos -->
<div id="modal-add-producto" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-add-producto')">&times;</span>
        <h2>Agregar Producto</h2>
        <form method="post" action="{% url 'create_producto' %}">
            {% csrf_token %}
            {{ producto_form.as_p }}
            <button type="submit" class="btn btn-primary">Agregar</button>
        </form>
    </div>
</div>

<div id="modal-edit-producto" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-edit-producto')">&times;</span>
        <h2>Editar Producto</h2>
        <form method="post" action="">
            {% csrf_token %}
            {{ producto_form.as_p }}
            <button type="submit" class="btn btn-primary">Actualizar</button>
        </form>
    </div>
</div>

<!-- Modales para agregar/editar tiendas -->
<div id="modal-add-tienda" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-add-tienda')">&times;</span>
        <h2>Agregar Tienda</h2>
        <form method="post" action="{% url 'create_tienda' %}">
            {% csrf_token %}
            {{ tienda_form.as_p }}
            <button type="submit" class="btn btn-primary">Agregar</button>
        </form>
    </div>
</div>

<div id="modal-edit-tienda" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-edit-tienda')">&times;</span>
        <h2>Editar Tienda</h2>
        <form method="post" action="">
            {% csrf_token %}
            {{ tienda_form.as_p }}
            <button type="submit" class="btn btn-primary">Actualizar</button>
        </form>
    </div>
</div>

<!-- Modales para agregar/editar categorías -->
<div id="modal-add-categoria" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-add-categoria')">&times;</span>
        <h2>Agregar Categoría</h2>
        <form method="post" action="{% url 'create_categoria' %}">
            {% csrf_token %}
            {{ categoria_form.as_p }}
            <button type="submit" class="btn btn-primary">Agregar</button>
        </form>
    </div>
</div>

<div id="modal-edit-categoria" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-edit-categoria')">&times;</span>
        <h2>Editar Categoría</h2>
        <form method="post" action="">
            {% csrf_token %}
            {{ categoria_form.as_p }}
            <button type="submit" class="btn btn-primary">Actualizar</button>
        </form>
    </div>
</div>

<!-- Modales para agregar/editar stock -->
<div id="modal-add-stock" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-add-stock')">&times;</span>
        <h2>Agregar Stock</h2>
        <form method="post" action="{% url 'create_stock' %}">
            {% csrf_token %}
            {{ stock_form.as_p }}
            <button type="submit" class="btn btn-primary">Agregar</button>
        </form>
    </div>
</div>

<div id="modal-edit-stock" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('modal-edit-stock')">&times;</span>
        <h2>Editar Stock</h2>
        <form method="post" action="">
            {% csrf_token %}
            {{ stock_form.as_p }}
            <button type="submit" class="btn btn-primary">Actualizar</button>
        </form>
    </div>
</div>

<script>
    function showSection(sectionId) {
        const sections = document.querySelectorAll('.table-container');
        sections.forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(sectionId).style.display = 'block';
    }

    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function deleteItem(action, itemId) {
        if (confirm('¿Estás seguro de que deseas eliminar este elemento?')) {
            window.location.href = `/admin/${action}/${itemId}/`;
        }
    }

    function openEditModal(modalId, itemId) {
        const form = document.querySelector(`#${modalId} form`);
        form.action = form.action.replace('itemId', itemId);
        document.getElementById(modalId).style.display = 'block';
        
    }

    function openEditUserModal(modalId, userId) {
    console.log(`Opening modal for user ID: ${userId}`);
    fetch(`/update_user/${userId}/`)
        .then(response => {
            console.log('Fetch response:', response);
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .then(data => {
            console.log('Fetch data:', data);
            if (data.success) {
                document.getElementById('editUsername').value = data.username;
                document.getElementById('editEmail').value = data.email;
                document.getElementById('editType').value = data.type;
                const form = document.getElementById('editUserForm');
                form.action = `/update_user/${userId}/`;
                document.getElementById(modalId).style.display = 'block';
            } else {
                console.error('Fetch data success false:', data);
            }
        })
        .catch(error => console.error('Fetch error:', error));
    }


function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showSection(sectionId) {
        // Ocultar todas las secciones
        document.querySelectorAll('.table-container').forEach(function(section) {
            section.style.display = 'none';
        });

        // Mostrar la sección seleccionada
        document.getElementById(sectionId).style.display = 'block';

        // Quitar la clase 'active' de todos los enlaces
        document.querySelectorAll('.nav-list a').forEach(function(link) {
            link.classList.remove('active');
        });

        // Añadir la clase 'active' al enlace seleccionado
        document.getElementById(sectionId + '-link').classList.add('active');
    }

    // Mostrar la sección de usuarios por defecto
    document.addEventListener('DOMContentLoaded', function() {
        showSection('usuarios');
    });


</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock %}
